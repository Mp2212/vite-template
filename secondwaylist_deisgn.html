<template>
  <div class="container mt-4">
    <!-- Selected Values Display -->
    <div class="selected-values-container mb-4">
      <h5 class="mb-3">Selected Values</h5>
      <div class="selected-values">
        <strong>Executives:</strong> {{ selectedTechExecutives.length > 0 ? selectedTechExecutives.map((e) => e.DisplayName).join(", ") : "None" }}
        <br />
        <strong>AITs:</strong> {{ selectedAITs.length > 0 ? selectedAITs.join(", ") : "None" }}
      </div>
    </div>

    <div class="row">
      <!-- Left Side: Tech Executives List -->
      <div class="col-md-5">
        <h5 class="list-title"><i class="fas fa-users"></i> Tech Executives</h5>
        <input
          v-model="searchExecutives"
          class="form-control search-bar mb-3"
          type="text"
          placeholder="Search Tech Executives"
        />
        <div class="custom-list">
          <ul>
            <li
              v-for="executive in filteredExecutives"
              :key="executive.Name"
              @click="toggleExecutiveSelection(executive)"
              :class="{ selected: selectedTechExecutives.includes(executive) }"
            >
              {{ executive.DisplayName }}
            </li>
          </ul>
        </div>
      </div>

      <!-- Right Side: Hierarchical AIT List -->
      <div class="col-md-7">
        <h5 class="list-title"><i class="fas fa-filter"></i> AITs</h5>
        <input
          v-model="searchAITs"
          class="form-control search-bar mb-3"
          type="text"
          placeholder="Search AITs"
        />
        <div class="custom-list">
          <ul>
            <li v-for="executive in filteredExecutivesWithAITs" :key="executive.techExec" class="group">
              <strong>{{ executive.techExec }}</strong>
              <ul class="nested-list">
                <li
                  v-for="ait in executive.ids"
                  :key="ait"
                  @click="toggleAITSelection(ait)"
                  :class="{ selected: selectedAITs.includes(ait) }"
                >
                  {{ ait }}
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from "vue";

const tech = ref([]);
const aits = ref([]);
const selectedTechExecutives = ref([]);
const selectedAITs = ref([]);
const searchExecutives = ref("");
const searchAITs = ref("");

// Fetch Tech Executives
const fetchTECH = async () => {
  try {
    const response = await fetch(`/horizon-inventory/getTechExecForOlympos`);
    if (!response.ok) {
      throw new Error("Network Error!");
    }
    const data = await response.json();
    const dataArray = Object.values(data);
    tech.value = dataArray.map((item) => {
      const [lastname, firstname] = item.split(", ").map((str) => str.trim());
      return { Name: item, DisplayName: `${firstname} ${lastname}` };
    });
  } catch (error) {
    console.error("Failed to fetch tech executives:", error);
  }
};

// Fetch AITs for Selected Tech Executives
const fetchAIT = async (selectedTech) => {
  try {
    const payload = {
      techExec: selectedTech.map((exec) => exec.Name),
    };
    const response = await fetch(`/horizon-inventory/getAITListForTechExecsForMultiSelect`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });
    if (!response.ok) {
      throw new Error("Network Error!");
    }
    const data = await response.json();
    aits.value = Object.entries(data).map(([techExec, ids]) => ({
      techExec,
      ids,
    }));
  } catch (error) {
    console.error("Failed to fetch AITs:", error);
  }
};

// Filtered Executives for Search
const filteredExecutives = computed(() => {
  return tech.value.filter((executive) =>
    executive.DisplayName.toLowerCase().includes(searchExecutives.value.toLowerCase())
  );
});

// Filtered Executives with AITs
const filteredExecutivesWithAITs = computed(() => {
  return aits.value.filter((ait) =>
    ait.techExec.toLowerCase().includes(searchAITs.value.toLowerCase())
  );
});

// Selection Methods
const toggleExecutiveSelection = async (executive) => {
  if (selectedTechExecutives.value.includes(executive)) {
    selectedTechExecutives.value = selectedTechExecutives.value.filter((e) => e !== executive);
  } else {
    selectedTechExecutives.value.push(executive);
  }
  await fetchAIT(selectedTechExecutives.value);
};

const toggleAITSelection = (ait) => {
  if (selectedAITs.value.includes(ait)) {
    selectedAITs.value = selectedAITs.value.filter((a) => a !== ait);
  } else {
    selectedAITs.value.push(ait);
  }
};

// On Mounted
onMounted(() => {
  fetchTECH();
});
</script>

<style scoped>
.container {
  max-width: 1200px;
}

/* Selected Values Section */
.selected-values-container {
  background-color: #f8f9fa;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.selected-values {
  font-size: 14px;
  line-height: 1.5;
}

/* List Titles */
.list-title {
  font-size: 16px;
  font-weight: bold;
  color: #333;
  margin-bottom: 8px;
}

/* Search Bars */
.search-bar {
  border-radius: 20px;
  padding: 8px 12px;
  font-size: 14px;
  border: 1px solid #ccc;
}

/* Custom List Styling */
.custom-list {
  height: 300px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  background-color: #ffffff;
}

.custom-list ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

.custom-list li {
  padding: 8px 10px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
  border-radius: 5px;
  font-size: 14px;
}

.custom-list li:hover {
  background-color: #e8f4fc;
  color: #007bff;
}

.custom-list li.selected {
  background-color: #b3d7ff;
  color: #0056b3;
}

.custom-list .group {
  font-size: 14px;
  font-weight: bold;
  color: #444;
  margin-bottom: 6px;
}

.custom-list .nested-list {
  margin-left: 20px;
}

.nested-list li {
  font-size: 13px;
  background-color: #f4f9fc;
  margin-bottom: 4px;
  padding-left: 15px;
  border-left: 3px solid #007bff;
}
</style>
