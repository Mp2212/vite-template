<script setup>
import { ref, onMounted, watch, nextTick } from 'vue';
import * as d3 from 'd3';
import axios from 'axios';

// --- 1. STATE ---
const viewMode = ref('tree'); 
const totalRootNodes = ref(0);
const flatApiData = ref([]);
const isLoading = ref(false);
const errorMsg = ref(null);
const selectedEnv = ref('SIT1');

// Shared Data Source
const currentHierarchyData = ref({ children: [] });

const svgRef = ref(null);
const containerRef = ref(null);
const gRef = ref(null);
const tooltipRef = ref(null);

// Search State
const searchQuery = ref(""); 
const searchTags = ref([]);  

// Pagination Settings
const currentPage = ref(1);
const rootPageSize = 5; 
const leafPageSize = 25; 
const totalJobs = ref(0);

let fullHierarchy = [];
let root = null;
let treemap = null;
let i = 0;
const duration = 400;

// Dimensions
const nodeHeight = 40; 
const nodeWidth = 280; 

// --- 2. DATA FETCHING ---
async function fetchApiData() {
  isLoading.value = true;
  errorMsg.value = null;
  try {
    // ============================================================
   
    // ============================================================
    /*
    const url = '/api';
    const params = { 
        techExecs: '',
        env: selectedEnv.value, 
        isProd: 'false' 
    };

    const response = await axios.get(url, { params });

    if (response.data && typeof response.data === 'object' && !Array.isArray(response.data)) {
        flatApiData.value = Object.values(response.data).flat();
    } else if (Array.isArray(response.data)) {
        flatApiData.value = response.data;
    } else {
        flatApiData.value = [];
    }
    */

   
    // ============================================================

    buildRawHierarchy();
    refreshView();

  } catch (error) {
    console.error("API Error:", error);
    errorMsg.value = "Error loading data. Ensure VPN/Proxy is connected.";
    flatApiData.value = []; 
  } finally {
    isLoading.value = false;
  }
}

// --- 3. HIERARCHY BUILDER ---
function buildRawHierarchy() {
  const execMap = new Map();
  if (!flatApiData.value) return;

  flatApiData.value.forEach(item => {
    const execName = item.techExec || 'Unknown Exec';
    const warName = item.warName || 'Unknown War';

    if (!execMap.has(execName)) {
      execMap.set(execName, {
        name: execName, type: 'exec', children: new Map(),
        id: `exec-${execName.replace(/\s+/g, '')}`, totalCount: 0, isExpanded: true
      });
    }
    const execNode = execMap.get(execName);

    if (!execNode.children.has(warName)) {
      execNode.children.set(warName, {
        name: warName, type: 'war', rawItems: [], children: [], 
        id: `war-${execName.replace(/\s+/g, '')}-${warName}`, totalCount: 0, isExpanded: false,
        gridPage: 1, treeLimit: 1
      });
    }
    const warNode = execNode.children.get(warName);
    warNode.rawItems.push(item);
  });

  fullHierarchy = Array.from(execMap.values()).map(exec => {
    const processedWars = Array.from(exec.children.values()).map(war => {
        war.totalCount = war.rawItems.length;
        war._allChildren = war.rawItems.map(item => createJarNode(item));
        
        const initialLimit = war.treeLimit * leafPageSize;
        war.children = war._allChildren.slice(0, initialLimit);
        
        if (war.children.length < war._allChildren.length) {
            war.children.push({
                name: `Load ${war._allChildren.length - initialLimit} more...`, 
                type: 'pager', parentNode: war, id: `pager-${war.id}`
            });
        }

        delete war.rawItems; 
        return war;
    });
    exec.totalCount = processedWars.reduce((sum, w) => sum + w.totalCount, 0);
    exec.children = processedWars;
    return exec;
  });

  totalRootNodes.value = fullHierarchy.length;
  totalJobs.value = totalRootNodes.value;
}

function createJarNode(item) {
    const isRisk = !!item.violationReason && item.violationReason !== "null";
    return {
        name: item.jarName, 
        type: 'jar', 
        data: item, 
        isRisk: isRisk,
        id: `jar-${item.ansibleJobId}-${item.jarName}-${Math.random()}`
    };
}

// --- 4. PAGINATION LOGIC ---
function paginateNode(node) {
    if(!node._allChildren) return;
    
    if (viewMode.value === 'grid') {
        const total = node._allChildren.length;
        const totalPages = Math.ceil(total / leafPageSize);
        if (node.gridPage < 1) node.gridPage = 1;
        if (node.gridPage > totalPages) node.gridPage = totalPages;
        const start = (node.gridPage - 1) * leafPageSize;
        const end = start + leafPageSize;
        node.children = node._allChildren.slice(start, end);
    } else {
        const limit = node.treeLimit * leafPageSize;
        const sliced = node._allChildren.slice(0, limit);
        node.children = [...sliced];
        if (node.children.length < node._allChildren.length) {
            node.children.push({
                name: `Load ${node._allChildren.length - limit} more...`, 
                type: 'pager', parentNode: node, id: `pager-${node.id}`
            });
        }
    }
}

function changeGroupPage(node, delta) {
    node.gridPage += delta;
    refreshView();
}

// --- 5. SEARCH LOGIC ---
function addSearchTag() {
    const val = searchQuery.value.trim();
    if (val && !searchTags.value.includes(val)) {
        searchTags.value.push(val);
    }
    searchQuery.value = ""; 
    refreshView();
}

function removeSearchTag(tag) {
    searchTags.value = searchTags.value.filter(t => t !== tag);
    refreshView();
}

function getDisplayData() {
  const activeTags = searchTags.value;
  
  const processPagination = (nodes) => {
      nodes.forEach(node => {
          if (node.type === 'war') {
              paginateNode(node);
          }
          if (node.children) processPagination(node.children);
      });
  }

  if (activeTags.length > 0) {
    const filterNodes = (nodes) => {
        const filtered = [];
        for(const node of nodes) {
            const raw = node.data || {};
            const searchableText = [
                node.name, 
                raw.violationReason, 
                raw.earName,
                raw.branch,
                raw.aitNumber,
                raw.ansibleJobId
            ].join(" ").toLowerCase();
            
            const isMatch = activeTags.some(tag => searchableText.includes(tag.toLowerCase()));

            let childrenSource = [];
            if(node.type === 'war') childrenSource = node._allChildren;
            else if (node.children) childrenSource = node.children;

            let matchingChildren = [];
            if(childrenSource && childrenSource.length > 0) {
                matchingChildren = filterNodes(childrenSource);
            }

            if(isMatch || matchingChildren.length > 0) {
                const newNode = { ...node };
                newNode.isExpanded = true; 
                if(matchingChildren.length > 0) {
                      newNode.children = matchingChildren;
                      newNode._children = null; 
                } else {
                    newNode.children = [];
                }
                filtered.push(newNode);
            }
        }
        return filtered;
    };
    return { name: "Search Results", type: "root", children: filterNodes(fullHierarchy) };
  }

  processPagination(fullHierarchy); 
  const start = (currentPage.value - 1) * rootPageSize;
  const end = start + rootPageSize;
  const visible = fullHierarchy.slice(start, end).map(x => ({...x})); 
  return { name: "Root", type: "root", children: visible };
}

// --- 6. VIEW CONTROL ---
function refreshView() {
    if (containerRef.value) {
        containerRef.value.scrollTop = 0;
        containerRef.value.scrollLeft = 0;
    }

    const data = getDisplayData();
    currentHierarchyData.value = data; 
    
    if (viewMode.value === 'tree') {
        nextTick(() => { if(svgRef.value) initD3Graph(data); });
    }
}

function toggleGridExpand(node) {
    node.isExpanded = !node.isExpanded;
}

// --- 7. D3 RENDERING ---
function initD3Graph(data) {
  root = d3.hierarchy(data, d => d.children);
  root.x0 = 0; root.y0 = 0;

  if (searchTags.value.length === 0 && root.children) {
    root.children.forEach(exec => {
      if (exec.children) {
        exec.children.forEach(war => {
            if (war.children) { war._children = war.children; war.children = null; }
        })
      }
    });
  }
  
  treemap = d3.tree()
    .nodeSize([nodeHeight, nodeWidth])
    .separation(() => 1); 

  const svg = d3.select(svgRef.value); 
  svg.selectAll("*").remove(); 
  gRef.value = svg.append("g");
  updateD3(root);
}

function updateD3(source) {
  const treeData = treemap(root); 
  const nodes = treeData.descendants();
  const links = treeData.links().filter(d => d.source.depth > 0);
  const visibleNodes = nodes.filter(d => d.depth > 0);
  
  visibleNodes.forEach(d => { d.y = (d.depth - 1) * nodeWidth; });

  let minX = Infinity; let maxX = -Infinity; let maxY = 0;
  visibleNodes.forEach(d => { 
      if (d.x < minX) minX = d.x; 
      if (d.x > maxX) maxX = d.x; 
      if (d.y > maxY) maxY = d.y;
  });

  if (minX === Infinity) { minX = 0; maxX = 0; }

  const treeHeight = Math.abs(maxX - minX); 
  const rightBuffer = 400; 
  const treeWidth = maxY + rightBuffer; 
  const verticalPadding = 40; 
  const leftPadding = 100; 

  const containerHeight = containerRef.value ? containerRef.value.clientHeight : 800;
  const containerWidth = containerRef.value ? containerRef.value.clientWidth : 1200;

  const finalHeight = Math.max(containerHeight, treeHeight + (verticalPadding * 2));
  const finalWidth = treeWidth;
  
  const exactHeight = treeHeight + (verticalPadding * 2);
  d3.select(svgRef.value).attr("height", exactHeight < containerHeight ? containerHeight : exactHeight).attr("width", finalWidth);

  const shiftY = Math.abs(minX) + verticalPadding;

  gRef.value.transition().duration(duration)
    .attr("transform", `translate(${leftPadding}, ${shiftY})`);

  const link = gRef.value.selectAll('path.link').data(links, d => d.target.id);
  const linkEnter = link.enter().insert('path', "g")
      .attr("class", "link")
      .attr('d', d => { const o = {x: source.x0, y: source.y0}; return diagonal(o, o); })
      .style("fill", "none")
      .style("stroke", "#cbd5e1")
      .style("stroke-width", "1.5px");

  link.merge(linkEnter).transition().duration(duration).attr('d', d => diagonal(d.source, d.target));
  link.exit().transition().duration(duration).attr('d', d => { const o = {x: source.x, y: source.y}; return diagonal(o, o); }).remove();

  const node = gRef.value.selectAll('g.node').data(visibleNodes, d => d.id || (d.id = ++i));
  const nodeEnter = node.enter().append('g').attr('class', d => `node ${d.data.type === 'pager' ? 'pager-node' : ''}`).attr("transform", d => `translate(${source.y0},${source.x0})`).on('click', clickD3);

  nodeEnter.filter(d => ['exec', 'war'].includes(d.data.type)).append('circle').attr('class', 'node-circle big-circle').attr('r', 1e-6).style("fill", d => getNodeColor(d)).style("stroke", "#fff").style("stroke-width", "2px");
  nodeEnter.filter(d => d.data.type === 'jar').append('circle').attr('class', 'node-circle small-circle').attr('r', 1e-6).style("fill", d => getNodeColor(d)).style("stroke", d => d.data.isRisk ? "#d32f2f" : "#fff");
  nodeEnter.filter(d => d.data.type === 'pager').append("rect").attr("width", 110).attr("height", 24).attr("y", -12).attr("rx", 12).attr("fill", "#e3f2fd").attr("stroke", "#2196f3").attr("cursor", "pointer");
  
  nodeEnter.filter(d => ['war'].includes(d.data.type)).append("text").attr("dy", "0.35em").attr("text-anchor", "middle").style("fill", "white").style("font-size", "9px").style("font-weight", "bold").style("pointer-events", "none").text(d => d.data.totalCount || 0);

  const expandIcon = nodeEnter.filter(d => d.children || d._children || (d.data._allChildren && d.data.type === 'war')).append("g").attr("class", "expand-icon").attr("transform", d => `translate(${d.data.type === 'jar' ? -12 : -18}, 0)`);
  expandIcon.append("circle").attr("r", 5).attr("fill", "#fff").attr("stroke", "#ccc");
  expandIcon.append("text").attr("dy", "0.35em").attr("text-anchor", "middle").attr("font-size", "9px").text(d => d.children ? "-" : "+");

  nodeEnter.filter(d => d.data.type !== 'pager').append('text').attr("dy", ".35em").attr("x", d => d.data.type === 'jar' ? 12 : 20).attr("text-anchor", "start").text(d => d.data.name).style("fill-opacity", 1e-6).style("font-weight", d => d.data.type === 'jar' ? "normal" : "bold").style("fill", "#333");
  nodeEnter.filter(d => d.data.type === 'pager').append('text').attr("class", "pager-label").attr("dy", ".35em").attr("x", 55).attr("text-anchor", "middle").text(d => d.data.name).style("fill", "#1976d2").style("font-weight", "bold").style("font-size", "11px").style("pointer-events", "none");

  nodeEnter.on("mouseover", (event, d) => {
    if(d.data.type === 'pager') return;
    const raw = d.data.data || {}; let content = '';
    if (d.data.type === 'exec') content = `<div class="tt-header">Tech Exec</div><div class="tt-row"><strong>${d.data.name}</strong></div>`;
    else if (d.data.type === 'war') content = `<div class="tt-header">WAR</div><div class="tt-row"><strong>${d.data.name}</strong></div><div class="tt-row">Total Jars: ${d.data.totalCount}</div>`;
    else if (d.data.type === 'jar') { 
        const isBad = d.data.isRisk;
        content = `<div class="tt-header ${isBad ? 'tt-error' : ''}">${raw.jarName}</div>
                   ${isBad ? `<div class="tt-alert">‚ö†Ô∏è ${raw.violationReason}</div>` : ''}
                   <div class="tt-grid">
                     <div><strong>Current:</strong> ${raw.currentVersion}</div>
                     <div><strong>Allowed:</strong> ${raw.allowedVersion}</div>
                     <div><strong>Branch:</strong> ${raw.branch}</div>
                     <div><strong>Deployed:</strong> ${raw.deployedDate}</div>
                   </div>`; 
    }
    tooltipRef.value.innerHTML = content; tooltipRef.value.style.opacity = 1; tooltipRef.value.style.left = (event.pageX + 15) + "px"; tooltipRef.value.style.top = (event.pageY - 20) + "px";
  }).on("mouseout", () => { tooltipRef.value.style.opacity = 0; });

  const nodeUpdate = node.merge(nodeEnter).transition().duration(duration).attr("transform", d => `translate(${d.y},${d.x})`);
  
  nodeUpdate.select('.big-circle').attr('r', 12).style("fill", d => getNodeColor(d)); 
  nodeUpdate.select('.small-circle').attr('r', 4.5).style("fill", d => getNodeColor(d));
  
  nodeUpdate.selectAll('text').style("fill-opacity", 1); nodeUpdate.select('.pager-label').text(d => d.data.name); nodeUpdate.select('.expand-icon text').text(d => d.children ? "-" : "+");
  const nodeExit = node.exit().transition().duration(duration).attr("transform", d => `translate(${source.y},${source.x})`).remove();
  nodeExit.selectAll('circle').attr('r', 1e-6); nodeExit.selectAll('text').style("fill-opacity", 1e-6);
  nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
}

function diagonal(s, d) { return `M ${s.y} ${s.x} C ${(s.y + d.y) / 2} ${s.x}, ${(s.y + d.y) / 2} ${d.x}, ${d.y} ${d.x}`; }

function getNodeColor(d) {
  if (d.data.type === 'exec') return '#6366f1'; 
  if (d.data.type === 'war') return '#f59e0b'; 
  if (d.data.type === 'jar') return d.data.isRisk ? '#ffe4e6' : '#ecfdf5'; 
  return '#ccc';
}

function clickD3(event, d) {
  if (d.data.type === 'pager') {
      const parentNodeData = d.data.parentNode; parentNodeData.treeLimit++; paginateNode(parentNodeData); 
      const parentD3Node = d.parent;
      const newD3Children = parentNodeData.children.map(childData => {
         const existing = parentD3Node.children ? parentD3Node.children.find(c => c.data.id === childData.id) : null;
         if (existing) { existing.data = childData; return existing; }
         const newNode = d3.hierarchy(childData); newNode.depth = parentD3Node.depth + 1; newNode.height = parentD3Node.height - 1; newNode.parent = parentD3Node; return newNode;
      });
      parentD3Node.children = newD3Children; updateD3(parentD3Node); return;
  }
  if (!d.children && !d._children && d.data.type === 'jar') return;
  if (d.children) { d._children = d.children; d.children = null; } else { d.children = d._children; d._children = null; }
  updateD3(d);
}

function nextPage() { if (currentPage.value * rootPageSize < totalJobs.value) { currentPage.value++; refreshView(); } }
function prevPage() { if (currentPage.value > 1) { currentPage.value--; refreshView(); } }
watch(searchQuery, () => { });
function handleResize() { if(viewMode.value === 'tree' && root) updateD3(root); }
onMounted(() => { fetchApiData(); window.addEventListener('resize', handleResize); });
</script>

<template>
  <div class="app-container">
    <div class="header">
      <div class="left-controls">
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <div class="tags-container">
              <span v-for="tag in searchTags" :key="tag" class="tag-pill">
                  {{ tag }} <span class="tag-close" @click="removeSearchTag(tag)">√ó</span>
              </span>
              <input 
                  v-model="searchQuery" 
                  @keydown.enter="addSearchTag" 
                  placeholder="Search and press Enter..." 
                  class="search-input-field" 
              />
          </div>
        </div>

        <div class="view-toggle">
          <button :class="{active: viewMode==='tree'}" @click="viewMode='tree'; refreshView()">Tree</button>
          <button :class="{active: viewMode==='grid'}" @click="viewMode='grid'; refreshView()">Grid</button>
        </div>
      </div>

      <div class="right-controls">
        <div class="env-badge">ENV: {{ selectedEnv }}</div>
        <div class="pagination-ctrl" v-if="searchTags.length === 0">
          <button @click="prevPage" :disabled="currentPage === 1">‚Äπ</button>
          <span class="page-text">{{ currentPage }} / {{ Math.ceil(totalJobs / rootPageSize) || 1 }}</span>
          <button @click="nextPage" :disabled="currentPage * rootPageSize >= totalJobs">‚Ä∫</button>
        </div>
      </div>
    </div>

    <div class="legend-bar">
        <div class="loading-text" v-if="isLoading">Loading Data...</div>
        <div class="error-text" v-if="errorMsg">{{ errorMsg }}</div>
        
        <div class="legend-item"><span class="dot exec"></span> Exec</div>
        <div class="legend-item"><span class="dot war"></span> WAR</div>
        <div class="legend-item"><span class="dot viol"></span> Risk</div>
        <div class="legend-item"><span class="dot comp"></span> Compliant</div>
    </div>

    <div class="content-area" ref="containerRef" :class="{ 'bg-grid': viewMode === 'grid' }">
      
      <div class="view-card">
        <svg v-show="viewMode === 'tree'" ref="svgRef" width="100%"></svg>

        <div v-if="viewMode === 'grid'" class="grid-table">
          <div class="grid-header">
              <div class="col-hier">Hierarchy / Component Name</div>
              <div class="col-ver">Versions (Cur | Allow)</div>
              <div class="col-meta">Branch / Date</div>
              <div class="col-ids">Metadata (AIT | ID)</div>
              <div class="col-status">Status</div>
          </div>
          
          <div class="grid-body">
              <template v-for="exec in currentHierarchyData.children" :key="exec.id">
                  <div class="row level-1" @click="toggleGridExpand(exec)">
                      <div class="col-hier">
                          <span class="toggle-icon">{{ exec.isExpanded ? '‚àí' : '+' }}</span>
                          <span class="dot exec"></span> {{ exec.name }}
                      </div>
                      <div class="col-ver text-muted"></div>
                      <div class="col-meta text-muted"></div>
                      <div class="col-ids text-muted"></div>
                      <div class="col-status text-muted">{{ exec.children.length }} WARs</div>
                  </div>
                  
                  <template v-if="exec.isExpanded">
                      <template v-for="war in exec.children" :key="war.id">
                          <div class="row level-2" @click="toggleGridExpand(war)">
                              <div class="col-hier">
                                  <span class="guide-line"></span>
                                  <span class="toggle-icon">{{ war.isExpanded ? '‚àí' : '+' }}</span>
                                  <span class="dot war"></span> {{ war.name }}
                              </div>
                              <div class="col-ver text-muted"></div>
                              <div class="col-meta text-muted"></div>
                              <div class="col-ids text-muted"></div>
                              <div class="col-status text-muted">{{ war.totalCount }} JARs</div>
                          </div>

                          <template v-if="war.isExpanded">
                              <template v-for="jar in war.children" :key="jar.id">
                                  <div class="row level-3 jar-row">
                                      <div class="col-hier">
                                          <span class="guide-line level-2-line"></span>
                                          <span class="guide-line level-3-line"></span>
                                          <span class="dot small" :class="jar.isRisk ? 'viol' : 'comp'"></span> 
                                          <span class="jar-name">{{ jar.name }}</span>
                                      </div>
                                      <div class="col-ver text-sm">
                                          <span class="ver-curr">{{ jar.data.currentVersion }}</span>
                                          <span class="ver-sep">/</span>
                                          <span class="ver-allow">{{ jar.data.allowedVersion }}</span>
                                      </div>
                                      <div class="col-meta text-sm">
                                          <div class="branch-name">{{ jar.data.branch }}</div>
                                          <div class="date-text">{{ jar.data.deployedDate?.split(' ')[0] }}</div>
                                      </div>
                                      <div class="col-ids text-sm text-muted">
                                          <div>AIT: {{ jar.data.aitNumber }}</div>
                                          <div>Job: {{ jar.data.ansibleJobId }}</div>
                                      </div>
                                      <div class="col-status">
                                          <span v-if="jar.data.violationReason" class="warn-pill">
                                              ‚ö†Ô∏è {{ jar.data.violationReason }}
                                          </span>
                                          <span v-else class="na-text">N/A</span>
                                      </div>
                                  </div>
                              </template>

                              <div class="row level-3 footer-row" v-if="war.totalCount > leafPageSize" @click.stop>
                                  <div class="pagination-box">
                                      <button class="btn-page" :disabled="war.gridPage === 1" @click.stop="changeGroupPage(war, -1)">‚óÄ</button>
                                      <span class="page-counter">{{ war.gridPage }} / {{ Math.ceil(war.totalCount / leafPageSize) }}</span>
                                      <button class="btn-page" :disabled="war.gridPage * leafPageSize >= war.totalCount" @click.stop="changeGroupPage(war, 1)">‚ñ∂</button>
                                  </div>
                              </div>
                          </template>
                      </template>
                  </template>
              </template>
          </div>
        </div>
      </div>

    </div>
    <div ref="tooltipRef" class="tooltip-bubble"></div>
  </div>
</template>

<style scoped>
/* GLOBAL RESET */
:global(body), :global(html) { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }

.app-container { display: flex; flex-direction: column; width: 100%; height: 100vh; background: #f8fafc; color: #334155; }

/* HEADER */
.header { 
    flex: 0 0 60px; background: white; border-bottom: 1px solid #e2e8f0; 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 0 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.02); 
}
.left-controls, .right-controls { display: flex; align-items: center; gap: 12px; }

/* SEARCH TAGS - FIXED BLACK BG */
.search-wrapper { 
    position: relative; display: flex; align-items: center; 
    background: white; border: 1px solid #cbd5e1; border-radius: 6px;
    padding: 3px 8px; width: 400px; transition: all 0.2s; min-height: 32px;
}
.search-wrapper:focus-within { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
.search-icon { color: #94a3b8; font-size: 14px; margin-right: 6px; }
.tags-container { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; align-items: center; }
.tag-pill { 
    background: #eff6ff; color: #4338ca; font-size: 11px; font-weight: 600; 
    padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; border: 1px solid #bfdbfe;
}
.tag-close { cursor: pointer; font-size: 12px; opacity: 0.6; }
.tag-close:hover { opacity: 1; }

/* ‚úÖ FIXED INPUT BACKGROUND */
.search-input-field { 
    border: none; outline: none; font-size: 12px; color: #334155; flex: 1; min-width: 100px;
    padding: 2px 0; background: transparent; 
}

/* TOGGLE */
.view-toggle { display: flex; background: #f1f5f9; padding: 3px; border-radius: 6px; }
.view-toggle button { 
    border: none; background: transparent; padding: 4px 12px; font-size: 12px; 
    font-weight: 600; color: #64748b; cursor: pointer; border-radius: 4px; transition: all 0.2s; 
}
.view-toggle button.active { background: white; color: #6366f1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

/* LEGEND BAR */
.legend-bar { 
    flex: 0 0 36px; background: white; border-bottom: 1px solid #e2e8f0; 
    display: flex; align-items: center; padding: 0 24px; gap: 16px; font-size: 11px; color: #64748b;
    justify-content: flex-end; /* ALIGN RIGHT */
}
.legend-item { display: flex; align-items: center; gap: 5px; font-weight: 600; }
.dot { width: 10px; height: 10px; border-radius: 50%; }
.exec { background: #6366f1; }
.war { background: #f59e0b; }
.viol { background: #f43f5e; }
.comp { background: #10b981; }
.small { width: 8px; height: 8px; }
.loading-text { color: #6366f1; font-weight: 600; margin-right: auto; }
.error-text { color: #f43f5e; font-weight: 600; margin-right: auto; }

/* CONTENT AREA */
.content-area { 
    flex: 1; overflow: auto; padding: 20px; background: #f8f9fa;
    scrollbar-width: none; -ms-overflow-style: none;
}
.content-area::-webkit-scrollbar { width: 6px; height: 6px; }
.content-area::-webkit-scrollbar-track { background: transparent; }
.content-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

.view-card {
    background: white; border: 1px solid #e2e8f0; border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); min-height: 100%; position: relative;
}

/* --- GRID TABLE STYLES --- */
.grid-header { 
    display: grid; 
    grid-template-columns: 2.8fr 1.2fr 1.5fr 1.5fr 1.5fr; 
    background: #f8fafc; border-bottom: 1px solid #e2e8f0; 
    padding: 8px 12px; font-size: 11px; font-weight: 700; 
    color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;
}
.row { 
    display: grid; 
    grid-template-columns: 2.8fr 1.2fr 1.5fr 1.5fr 1.5fr; 
    padding: 4px 12px; border-bottom: 1px solid #f1f5f9; 
    align-items: center; transition: background 0.1s; cursor: pointer; min-height: 36px;
}
.row:hover { background: #f8fafc; }

/* Column Specifics */
.col-hier { display: flex; align-items: center; gap: 8px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-weight: 500; font-size: 12px; }
.col-ver { display: flex; align-items: center; font-size: 11px; gap: 4px; }
.ver-curr { color: #334155; font-weight: 600; }
.ver-sep { color: #cbd5e1; }
.ver-allow { color: #64748b; }
.col-meta { display: flex; flex-direction: column; font-size: 10px; line-height: 1.2; color: #64748b; }
.col-ids { display: flex; flex-direction: column; font-size: 10px; line-height: 1.2; }
.branch-name { font-weight: 600; color: #475569; }
.col-status { display: flex; align-items: center; font-size: 11px; }

/* Status Badges */
.warn-pill { background: #fff1f2; color: #be123c; padding: 1px 6px; border-radius: 4px; font-weight: 600; font-size: 10px; border: 1px solid #fda4af; }
.na-text { color: #94a3b8; font-style: italic; font-size: 11px; }

/* Indentation Lines */
.toggle-icon { width: 14px; text-align: center; color: #94a3b8; font-size: 12px; font-weight: bold; }
.guide-line { width: 1px; height: 36px; background: #e2e8f0; margin-right: 6px; display: inline-block; }
.level-1 { background: #fff; border-left: 3px solid #6366f1; }
.level-2 { padding-left: 24px; border-left: 3px solid transparent; }
.level-3 { padding-left: 48px; font-size: 12px; border-left: 3px solid transparent; } 
.jar-row:hover { background: #fff; }

.pagination-ctrl { display: flex; align-items: center; gap: 6px; }
.pagination-ctrl button { width: 24px; height: 24px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
.page-text { font-size: 11px; font-weight: 600; color: #64748b; min-width: 30px; text-align: center; }

/* ‚úÖ FIXED PAGINATION BUTTONS */
.pagination-box { 
    display: inline-flex; align-items: center; gap: 12px; 
    background: white; border: 1px solid #e2e8f0; padding: 4px 12px; 
    border-radius: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.btn-page { 
    background: white; border: 1px solid #e2e8f0; padding: 4px 10px; 
    font-size: 11px; font-weight: 600; color: #475569; border-radius: 4px; 
    cursor: pointer; transition: all 0.2s; 
}
.btn-page:hover:not(:disabled) { border-color: #94a3b8; color: #0f172a; background: #f8fafc; }
.btn-page:disabled { opacity: 0.4; cursor: not-allowed; }
.page-counter { font-size: 11px; font-weight: 600; color: #64748b; }

.tooltip-bubble { 
    position: absolute; background: white; border: 1px solid #e2e8f0; 
    padding: 8px; border-radius: 6px; font-size: 11px; color: #334155; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 9999; pointer-events: none; opacity: 0;
}
:deep(.tt-header) { font-weight: 700; font-size: 12px; margin-bottom: 4px; color: #4338ca; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; }
:deep(.tt-grid) { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
</style>