<script setup>
import { ref, onMounted, watch, nextTick } from 'vue';
import * as d3 from 'd3';
import axios from 'axios';
import ExportMenu from './components/ExportMenu.vue';

// --- 1. STATE ---
const viewMode = ref('tree'); 
const totalRootNodes = ref(0);
const flatApiData = ref([]);
const isLoading = ref(false);
const errorMsg = ref(null);
const selectedEnv = ref('SIT1');

// Shared Data Source
const currentHierarchyData = ref({ children: [] });

const svgRef = ref(null);
const containerRef = ref(null);
const gRef = ref(null);
const tooltipRef = ref(null);

// Search State
const searchQuery = ref(""); 
const searchTags = ref([]);  

// Pagination Settings
const currentPage = ref(1);
const rootPageSize = 5; 
const leafPageSize = 25; 
const totalJobs = ref(0);

let fullHierarchy = [];
let root = null;
let treemap = null;
let i = 0;
const duration = 400;

// Dimensions
const nodeHeight = 40; 
const nodeWidth = 280; 

// --- 2. DATA FETCHING ---
async function fetchApiData() {
  isLoading.value = true;
  errorMsg.value = null;
  try {
    // ============================================================
   
    // ============================================================
    /*
    const url = '/api';
    const params = { 
        techExecs: '',
        env: selectedEnv.value, 
        isProd: 'false' 
    };

    const response = await axios.get(url, { params });

    if (response.data && typeof response.data === 'object' && !Array.isArray(response.data)) {
        flatApiData.value = Object.values(response.data).flat();
    } else if (Array.isArray(response.data)) {
        flatApiData.value = response.data;
    } else {
        flatApiData.value = [];
    }
    */

    // ============================================================
    // 2. MOCK DATA (ACTIVE - COMMENT OUT FOR PROD)
    // ============================================================
    await new Promise(resolve => setTimeout(resolve, 800)); 
    const mockData = [];
    for(let i=0; i < 500; i++) {
        const isRisk = i % 10 === 0; 
        mockData.push({
            ansibleJobId: 42523900 + i, 
            aitNumber: "7398" + (i % 9),
            applicationType: i % 2 === 0 ? "Micro App" : "Monolith",
            earName: `awardsactivity_t${i % 5}`,
            techExec: i < 250 ? "Amit George" : "Luv Pahwa",
            warName: i < 250 ? "payment-gateway" : "frontend-ui",
            jarName: `commons-lib-${i}.jar`,
            violationReason: isRisk ? (i % 20 === 0 ? "CVE-CRITICAL-RCE" : "Medium-Risk-License") : null,
            currentVersion: "1.0." + i, 
            allowedVersion: "2.0.0", 
            branch: "hotfix/2025.11.0",
            deployedDate: "2025-11-05 04:22 PM EST",
            deploymentEnvironment: "PROD"
        });
    }
    // Add a specific case
    mockData.push({ 
        ansibleJobId: 9999999, 
        aitNumber: "88888",
        applicationType: "Micro Service",
        earName: "auth_service_ear",
        techExec: "Thomas Richard", 
        warName: "auth-service", 
        jarName: "spring-core.jar", 
        violationReason: null, 
        currentVersion: "5.0.1", 
        allowedVersion: "5.0.1",
        branch: "release/2025.10",
        deployedDate: "2025-10-12 10:00 AM EST" 
    });

    flatApiData.value = mockData;
    // ============================================================

    buildRawHierarchy();
    refreshView();

  } catch (error) {
    console.error("API Error:", error);
    errorMsg.value = "Error loading data. Ensure VPN/Proxy is connected.";
    flatApiData.value = []; 
  } finally {
    isLoading.value = false;
  }
}
function hideTooltip() {
  if (tooltipRef.value) {
    tooltipRef.value.style.opacity = 0;
    tooltipRef.value.style.left = "-1000px"; // Move it off-screen to prevent accidental blocking
    tooltipRef.value.style.top = "-1000px";
  }
}
// --- 3. HIERARCHY BUILDER ---
function buildRawHierarchy() {
  const earMap = new Map(); // Root is EAR
  if (!flatApiData.value) return;

  flatApiData.value.forEach(item => {
    const earName = item.earName || 'Unknown EAR'; 
    // CHANGE: Use applicationType for Level 2
    const appTypeName = item.applicationType || 'Unknown Type'; 
    const warName = item.warName || 'Unknown War';

    // 1. Level: EAR (Root)
    if (!earMap.has(earName)) {
      earMap.set(earName, {
        name: earName, type: 'ear', children: new Map(),
        id: `ear-${earName.replace(/[^a-zA-Z0-9]/g, '')}`, totalCount: 0, isExpanded: true
      });
    }
    const earNode = earMap.get(earName);

    // 2. Level: Application Type (Child of EAR)
    if (!earNode.children.has(appTypeName)) {
        earNode.children.set(appTypeName, {
            name: appTypeName, type: 'appType', children: new Map(), // Type is now 'appType'
            id: `type-${earName}-${appTypeName.replace(/[^a-zA-Z0-9]/g, '')}`, totalCount: 0, isExpanded: true
        });
    }
    const typeNode = earNode.children.get(appTypeName);

    // 3. Level: WAR (Child of App Type)
    if (!typeNode.children.has(warName)) {
      typeNode.children.set(warName, {
        name: warName, type: 'war', rawItems: [], children: [], 
        id: `war-${warName.replace(/[^a-zA-Z0-9]/g, '')}`, totalCount: 0, isExpanded: false,
        gridPage: 1, treeLimit: 1
      });
    }
    const warNode = typeNode.children.get(warName);
    warNode.rawItems.push(item);
  });

  // Convert Maps to Arrays (EAR -> APP TYPE -> WAR)
  fullHierarchy = Array.from(earMap.values()).map(ear => {
    const processedTypes = Array.from(ear.children.values()).map(appType => {
        const processedWars = Array.from(appType.children.values()).map(war => {
            // WAR Processing (Same as before)
            war.totalCount = war.rawItems.length;
            war._allChildren = war.rawItems.map(item => createJarNode(item));
            const initialLimit = war.treeLimit * leafPageSize;
            war.children = war._allChildren.slice(0, initialLimit);
            if (war.children.length < war._allChildren.length) {
                war.children.push({ name: `Load...`, type: 'pager', parentNode: war, id: `pager-${war.id}` });
            }
            delete war.rawItems; 
            return war;
        });
        appType.children = processedWars;
        appType.totalCount = processedWars.reduce((sum, w) => sum + w.totalCount, 0);
        return appType;
    });
    ear.children = processedTypes;
    ear.totalCount = processedTypes.reduce((sum, e) => sum + e.totalCount, 0);
    return ear;
  });

  totalRootNodes.value = fullHierarchy.length;
  totalJobs.value = totalRootNodes.value; 
}

function createJarNode(item) {
    const isRisk = !!item.violationReason && item.violationReason !== "null";
    return {
        name: item.jarName, 
        type: 'jar', 
        data: item, 
        isRisk: isRisk,
        id: `jar-${item.ansibleJobId}-${item.jarName}-${Math.random()}`
    };
}

// --- 4. PAGINATION LOGIC ---
function paginateNode(node) {
    if(!node._allChildren) return;
    
    if (viewMode.value === 'grid') {
        const total = node._allChildren.length;
        const totalPages = Math.ceil(total / leafPageSize);
        if (node.gridPage < 1) node.gridPage = 1;
        if (node.gridPage > totalPages) node.gridPage = totalPages;
        const start = (node.gridPage - 1) * leafPageSize;
        const end = start + leafPageSize;
        node.children = node._allChildren.slice(start, end);
    } else {
        const limit = node.treeLimit * leafPageSize;
        const sliced = node._allChildren.slice(0, limit);
        node.children = [...sliced];
        if (node.children.length < node._allChildren.length) {
            node.children.push({
                name: `Load ${node._allChildren.length - limit} more...`, 
                type: 'pager', parentNode: node, id: `pager-${node.id}`
            });
        }
    }
}

function changeGroupPage(node, delta) {
    node.gridPage += delta;
    refreshView();
}

// --- 5. SEARCH LOGIC ---
function addSearchTag() {
    const val = searchQuery.value.trim();
    if (val && !searchTags.value.includes(val)) {
        searchTags.value.push(val);
    }
    searchQuery.value = ""; 
    refreshView();
}

function removeSearchTag(tag) {
    searchTags.value = searchTags.value.filter(t => t !== tag);
    refreshView();
}

// --- NEW REFACTORED STATE FOR EXPORT ---
const exportableData = ref([]); // Holds the full list for the export buttons

function getDisplayData() {
  const activeTags = searchTags.value;
 
  const filterNodes = (nodes) => {
    const filtered = [];
    for(const node of nodes) {
      const raw = node.data || {};
      let searchableText = "";
       if (node.type === 'jar') {
         searchableText = [node.name, raw.violationReason].join(" ").toLowerCase();
      } else {
         searchableText = node.name.toLowerCase();
      }
      const isMatch = activeTags.some(tag => searchableText.includes(tag.toLowerCase()));
      let childrenSource = [];
      if(node.type === 'war') childrenSource = node._allChildren; // Use backup of all jars
      else if (node.children) childrenSource = node.children;
     let matchingChildren = [];
      if(childrenSource && childrenSource.length > 0) {
        matchingChildren = filterNodes(childrenSource);
      }
      if(activeTags.length === 0 || isMatch || matchingChildren.length > 0) {
        const newNode = { ...node };
        if (activeTags.length > 0) newNode.isExpanded = true; 
        if(matchingChildren.length > 0) {
            newNode.children = matchingChildren;
            newNode._allChildren = matchingChildren; 
        } else if (activeTags.length === 0) {
            newNode.children = childrenSource ? childrenSource.map(c => ({...c})) : [];
            newNode._allChildren = newNode.children;
        } else if (isMatch) {
            newNode.children = childrenSource ? childrenSource.map(c => ({...c})) : [];
             newNode._allChildren = newNode.children;
        } else {
            newNode.children = [];
        }
        filtered.push(newNode);
      }
    }
    return filtered;
  };

  const allFilteredNodes = activeTags.length > 0 ? filterNodes(fullHierarchy) : fullHierarchy;
  exportableData.value = allFilteredNodes;

  const start = (currentPage.value - 1) * rootPageSize;
  const end = start + rootPageSize;
  const visibleRootNodes = allFilteredNodes.slice(start, end).map(x => ({...x}));
  return { name: "Root", type: "root", children: visibleRootNodes };
}
// --- 6. VIEW CONTROL ---
function refreshView() {
    hideTooltip()
    if (containerRef.value) {
        containerRef.value.scrollTop = 0;
        containerRef.value.scrollLeft = 0;
    }
    watch(viewMode, () => hideTooltip());
watch(searchQuery, () => hideTooltip());

    const data = getDisplayData();
    currentHierarchyData.value = data; 
    
    if (viewMode.value === 'tree') {
        nextTick(() => { if(svgRef.value) initD3Graph(data); });
    }
}

function toggleGridExpand(node) {
    node.isExpanded = !node.isExpanded;
}

// --- 7. D3 RENDERING ---
function initD3Graph(data) {
  root = d3.hierarchy(data, d => d.children);
  root.x0 = 0; root.y0 = 0;

  // --- FORCE COLLAPSE BASED ON FLAG ---
  const applyCollapse = (d) => {
    if (d.children) {
      d.children.forEach(applyCollapse);
    }
    // If flag is explicitly false, hide children
    if (d.data.isExpanded === false && d.children) {
      d._children = d.children;
      d.children = null;
    }
  };
  
  // Apply this to the entire tree before rendering
  if (root.children) {
     root.children.forEach(applyCollapse);
  }
  // ------------------------------------

  treemap = d3.tree()
    .nodeSize([nodeHeight, nodeWidth])
    .separation(() => 1); 

  const svg = d3.select(svgRef.value); 
  svg.selectAll("*").remove(); 
  gRef.value = svg.append("g");
  updateD3(root);
}
function updateD3(source) {
    hideTooltip();
  const treeData = treemap(root); 
  const nodes = treeData.descendants();
  const links = treeData.links().filter(d => d.source.depth > 0);
  const visibleNodes = nodes.filter(d => d.depth > 0);
  
  visibleNodes.forEach(d => { d.y = (d.depth - 1) * nodeWidth; });

  let minX = Infinity; let maxX = -Infinity; let maxY = 0;
  visibleNodes.forEach(d => { 
      if (d.x < minX) minX = d.x; 
      if (d.x > maxX) maxX = d.x; 
      if (d.y > maxY) maxY = d.y;
  });

  if (minX === Infinity) { minX = 0; maxX = 0; }

  const treeHeight = Math.abs(maxX - minX); 
  const rightBuffer = 400; 
  const treeWidth = maxY + rightBuffer; 
  const verticalPadding = 40; 
  const leftPadding = 100; 

  const containerHeight = containerRef.value ? containerRef.value.clientHeight : 800;
  const containerWidth = containerRef.value ? containerRef.value.clientWidth : 1200;

  const finalHeight = Math.max(containerHeight, treeHeight + (verticalPadding * 2));
  const finalWidth = treeWidth;
  
  const exactHeight = treeHeight + (verticalPadding * 2);
  d3.select(svgRef.value).attr("height", exactHeight < containerHeight ? containerHeight : exactHeight).attr("width", finalWidth);

  const shiftY = Math.abs(minX) + verticalPadding;

  gRef.value.transition().duration(duration)
    .attr("transform", `translate(${leftPadding}, ${shiftY})`);

  const link = gRef.value.selectAll('path.link').data(links, d => d.target.id);
  const linkEnter = link.enter().insert('path', "g")
      .attr("class", "link")
      .attr('d', d => { const o = {x: source.x0, y: source.y0}; return diagonal(o, o); })
      .style("fill", "none")
      .style("stroke", "#cbd5e1")
      .style("stroke-width", "1.5px");

  link.merge(linkEnter).transition().duration(duration).attr('d', d => diagonal(d.source, d.target));
  link.exit().transition().duration(duration).attr('d', d => { const o = {x: source.x, y: source.y}; return diagonal(o, o); }).remove();

  const node = gRef.value.selectAll('g.node').data(visibleNodes, d => d.id || (d.id = ++i));
  const nodeEnter = node.enter().append('g').attr('class', d => `node ${d.data.type === 'pager' ? 'pager-node' : ''}`).attr("transform", d => `translate(${source.y0},${source.x0})`).on('click', clickD3);

  nodeEnter.filter(d => ['exec', 'ear', 'war'].includes(d.data.type))
    .append('circle')
    .attr('class', 'node-circle big-circle')
    .attr('r', 1e-6)
    .style("fill", d => getNodeColor(d))
    .style("stroke", "#fff")
    .style("stroke-width", "2px");
    
  nodeEnter.filter(d => d.data.type === 'jar').append('circle').attr('class', 'node-circle small-circle').attr('r', 1e-6).style("fill", d => getNodeColor(d)).style("stroke", d => d.data.isRisk ? "#d32f2f" : "#fff");
  nodeEnter.filter(d => d.data.type === 'pager').append("rect").attr("width", 110).attr("height", 24).attr("y", -12).attr("rx", 12).attr("fill", "#e3f2fd").attr("stroke", "#2196f3").attr("cursor", "pointer");
  
 // nodeEnter.filter(d => ['war'].includes(d.data.type)).append("text").attr("dy", "0.35em").attr("text-anchor", "middle").style("fill", "white").style("font-size", "9px").style("font-weight", "bold").style("pointer-events", "none").text(d => d.data.totalCount || 0);

// NEW CODE: Adds 'ear' and 'appType' to the filter list
// 1. DRAW THE CIRCLES FIRST (Background)
// Ensure 'appType' is in this list!
nodeEnter.filter(d => ['ear', 'appType', 'war'].includes(d.data.type))
  .append('circle')
  .attr('class', 'node-circle big-circle')
  .attr('r', 1e-6) // Animation start radius
  .style("fill", d => getNodeColor(d))
  .style("stroke", "#fff")
  .style("stroke-width", "2px");
// 2. DRAW THE TEXT SECOND (Foreground)
// This puts the text ON TOP of the circle
nodeEnter.filter(d => ['ear'].includes(d.data.type))
  .append("text")
  .attr("dy", "0.35em")
  .attr("text-anchor", "middle")
  .style("fill", "white")
  .style("font-size", "9px")
  .style("font-weight", "bold")
  .style("pointer-events", "none")
  .text(d => d.data.totalCount || 0);

  const expandIcon = nodeEnter.filter(d => d.children || d._children || (d.data._allChildren && d.data.type === 'war')).append("g").attr("class", "expand-icon").attr("transform", d => `translate(${d.data.type === 'jar' ? -12 : -18}, 0)`);
  expandIcon.append("circle").attr("r", 5).attr("fill", "#fff").attr("stroke", "#ccc");
  expandIcon.append("text").attr("dy", "0.35em").attr("text-anchor", "middle").attr("font-size", "9px").text(d => d.children ? "-" : "+");

  nodeEnter.filter(d => d.data.type !== 'pager').append('text').attr("dy", ".35em").attr("x", d => d.data.type === 'jar' ? 12 : 20).attr("text-anchor", "start").text(d => d.data.name).style("fill-opacity", 1e-6).style("font-weight", d => d.data.type === 'jar' ? "normal" : "bold").style("fill", "#333");
  nodeEnter.filter(d => d.data.type === 'pager').append('text').attr("class", "pager-label").attr("dy", ".35em").attr("x", 55).attr("text-anchor", "middle").text(d => d.data.name).style("fill", "#1976d2").style("font-weight", "bold").style("font-size", "11px").style("pointer-events", "none");

  nodeEnter.on("mouseover", (event, d) => {
    if(d.data.type === 'pager') return;
    
    const raw = d.data.data || {}; 
    let content = '';

    // 1. Add logic for EAR type here
    // if (d.data.type === 'exec') {
    //     content = `<div class="tt-header">Tech Exec</div><div class="tt-row"><strong>${d.data.name}</strong></div>`;
    // } 
     if (d.data.type === 'ear') { // ✅ NEW: Handle EAR Tooltip
       content = `<div class="tt-header">EAR Name</div><div class="tt-row"><strong>${d.data.name}</strong></div>`;
    }
    else if (d.data.type === 'appType') {
    content = `<div class="tt-header">Application Type</div>
               <div class="tt-row"><strong>${d.data.name}</strong></div>
               <div class="tt-row">Total WARs: ${d.children ? d.children.length : 0}</div>`;
    }
    else if (d.data.type === 'war') {
        content = `<div class="tt-header">WAR</div><div class="tt-row"><strong>${d.data.name}</strong></div><div class="tt-row">Total Jars: 
            ${d.data.totalCount}</div>`;
    } 
    else if (d.data.type === 'jar') { 
        const isBad = d.data.isRisk;
        content = `<div class="tt-header ${isBad ? 'tt-error' : ''}">${raw.jarName}</div>
                   ${isBad ? `<div class="tt-alert">⚠️ ${raw.violationReason}</div>` : ''}
                   <div class="tt-grid">
                     <div><strong>Current:</strong> ${raw.currentVersion}</div>
                     <div><strong>Allowed:</strong> ${raw.allowedVersion}</div>
                     <div><strong>Branch:</strong> ${raw.branch}</div>
                     <div><strong>Deployed:</strong> ${raw.deployedDate}</div>
                   </div>`; 
    }

    // 2. Add this Safety Check: Don't show if empty
    if (!content) return; 

    tooltipRef.value.innerHTML = content; 
    tooltipRef.value.style.opacity = 1; 
    tooltipRef.value.style.left = (event.pageX + 15) + "px"; 
    tooltipRef.value.style.top = (event.pageY - 20) + "px";
  })

  const nodeUpdate = node.merge(nodeEnter).transition().duration(duration).attr("transform", d => `translate(${d.y},${d.x})`);
  
  nodeUpdate.select('.big-circle').attr('r', 12).style("fill", d => getNodeColor(d)); 
  nodeUpdate.select('.small-circle').attr('r', 4.5).style("fill", d => getNodeColor(d));
  
  nodeUpdate.selectAll('text').style("fill-opacity", 1); nodeUpdate.select('.pager-label').text(d => d.data.name); nodeUpdate
  .select('.expand-icon text').text(d => d.children ? "-" : "+");
  const nodeExit = node.exit().transition().duration(duration).attr("transform", d => `translate(${source.y},${source.x})`).remove();
  nodeExit.selectAll('circle').attr('r', 1e-6); nodeExit.selectAll('text').style("fill-opacity", 1e-6);
  nodes.forEach(d => { d.x0 = d.x; d.y0 = d.y; });
}

function diagonal(s, d) { return `M ${s.y} ${s.x} C ${(s.y + d.y) / 2} ${s.x}, ${(s.y + d.y) / 2} ${d.x}, ${d.y} ${d.x}`; }

function getNodeColor(d) {
  if (d.data.type === 'ear') return '#6366f1'; // Indigo
  if (d.data.type === 'appType') return '#06b6d4'; // Cyan (Level 2)
  if (d.data.type === 'war') return '#f59e0b'; // Amber
  if (d.data.type === 'jar') return d.data.isRisk ? '#ffe4e6' : '#ecfdf5'; 
  return '#ccc';
}
// Add this helper function
function checkTooltipVisibility(event) {
    // 1. Try to find if the mouse target is part of a D3 Node
    // Using .closest('.node') works for SVG elements too
    const isHoveringNode = event.target.closest('.node');

    // 2. If we are NOT touching a node, force hide the tooltip
    if (!isHoveringNode) {
        hideTooltip();
    }
}
const envList = ref([]); 

async function fetchEnvironments() {
  try {
    console.log("Fetching environments...");
    
    let rawData = "";

    // ============================================================
    // 1. LOCAL DEV: Hardcoded "Messy" Data (Matches your Screenshot)
    // ============================================================
    // This string mimics exactly what your API is returning:
    // A valid array first, followed immediately by invalid JSON objects.
    const mockApiString = `["CERT4", "CIT", "CIT1", "CIT2", "CIT3", "CIT4", "CIT5", "DEV", "DEV1", "DEV2", "DEV3", "DEV4", "DEV5", "DEVFLEX", "DIF", "DIF1", "DIF4", "PL1", "PL2", "PREPRODAZ", "PREPRODTX", "PREPRODVA", "PREVIEW1", "PREVIEW2", "PSSIT", "PT1", "PT2", "QA", "REVIEW1", "REVIEW2", "SAPE", "SE", "SE1", "SIT", "SIT1", "SIT2", "SIT3", "SITBC", "TT-TX", "TT-VA"]
    {
        "id": "23",
        "aggregatedEnvironment": "CERT4",
        "environments": "CERT4",
        "prodFlag": "N"
    }`;
    
    // Assign mock data for local test
    rawData = mockApiString; 

    // ============================================================
    // 2. PRODUCTION: Real API Call (Uncomment for Prod)
    // ============================================================
    /*
    const response = await axios.get('');
    rawData = response.data;
    
    // Ensure it's a string before processing
    if (typeof rawData !== 'string') {
        rawData = JSON.stringify(rawData);
    }
    */
    // ============================================================

    // --- PARSING LOGIC (Handles the mixed format) ---
    // We only want the text between the first '[' and the first ']'
    const start = rawData.indexOf('[');
    const end = rawData.indexOf(']');

    if (start !== -1 && end !== -1) {
        // Extract strictly the array part
        const cleanJson = rawData.substring(start, end + 1);
        
        try {
            // Parse into a real JS Array
            envList.value = JSON.parse(cleanJson);
            
            console.log("Parsed Environments:", envList.value);

            // Default Selection
            if (envList.value.length > 0) {
                selectedEnv.value = envList.value[0];
            }
            
            // Load Grid
            fetchApiData();
            
        } catch (e) {
            console.error("JSON Parse Error:", e);
        }
    } else {
        console.warn("Could not find environment array brackets [ ]");
    }

  } catch (error) {
    console.error("Failed to load environments:", error);
  }
}
function clickD3(event, d) {
  if (d.data.type === 'pager') {
      const parentNodeData = d.data.parentNode; parentNodeData.treeLimit++; paginateNode(parentNodeData); 
      const parentD3Node = d.parent;
      const newD3Children = parentNodeData.children.map(childData => {
         const existing = parentD3Node.children ? parentD3Node.children.find(c => c.data.id === childData.id) : null;
         if (existing) { existing.data = childData; return existing; }
         const newNode = d3.hierarchy(childData); newNode.depth = parentD3Node.depth + 1; newNode.height = parentD3Node.height - 1; newNode.parent = parentD3Node; return newNode;
      });
      parentD3Node.children = newD3Children; updateD3(parentD3Node); return;
  }
  if (!d.children && !d._children && d.data.type === 'jar') return;
  if (d.children) { d._children = d.children; d.children = null; } else { d.children = d._children; d._children = null; }
  updateD3(d);
}

function nextPage() { if (currentPage.value * rootPageSize < totalJobs.value) { currentPage.value++; refreshView(); } }
function prevPage() { if (currentPage.value > 1) { currentPage.value--; refreshView(); } }
watch(searchQuery, () => { });
function handleResize() { if(viewMode.value === 'tree' && root) updateD3(root); }
onMounted(() => { fetchEnvironments(); fetchApiData(); window.addEventListener('resize', handleResize); });
</script>

<template>
  <div class="app-container">

<div class="header">
    <div class="left-controls">
        
        <div class="env-selector-wrapper">
            <span class="env-label">ENVIRONMENT</span>
            <div class="select-container">
                <select id="envSelect" v-model="selectedEnv" @change="fetchApiData" class="env-dropdown">
                    <option v-for="env in envList" :key="env" :value="env">{{ env }}</option>
                </select>
                <svg class="dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>

        <div class="separator"></div>

        <div class="search-wrapper">
            <span class="search-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </span>
            <div class="tags-container">
                <span v-for="tag in searchTags" :key="tag" class="tag-pill">
                    {{ tag }} <span class="tag-close" @click="removeSearchTag(tag)">×</span>
                </span>
                <input 
                    v-model="searchQuery" 
                    @keydown.enter="addSearchTag" 
                    placeholder="Search components..." 
                    class="search-input-field" 
                />
            </div>
        </div>

        <ExportMenu :rawHierarchy="exportableData" />

    </div>

    <div class="right-controls">
        
        <div class="view-toggle">
            <button :class="{active: viewMode==='tree'}" @click="viewMode='tree'; refreshView()">
                <span class="icon">⫚</span> Tree
            </button>
            <button :class="{active: viewMode==='grid'}" @click="viewMode='grid'; refreshView()">
                <span class="icon">▦</span> Grid
            </button>
        </div>

        <div class="separator"></div>

        <div class="pagination-ctrl" v-if="searchTags.length === 0">
            <button @click="prevPage" :disabled="currentPage === 1" title="Previous Page">‹</button>
            <span class="page-text">{{ currentPage }} <span class="text-muted">/ {{ Math.ceil(totalJobs / rootPageSize) || 1 }}</span></span>
            <button @click="nextPage" :disabled="currentPage * rootPageSize >= totalJobs" title="Next Page">›</button>
        </div>

    </div>
</div>

<div class="legend-bar">
    <div class="legend-item"><span class="dot exec"></span> EAR</div>
    <div class="legend-item"><span class="dot ear"></span> App Type</div>
    <div class="legend-item"><span class="dot war"></span> WAR</div>
    <div class="legend-item"><span class="dot viol"></span> Risk</div>
    <div class="legend-item"><span class="dot comp"></span> Compliant</div>
</div>

    <div class="content-area" ref="containerRef" :class="{ 'bg-grid': viewMode === 'grid' }">
      
      <div class="view-card" @mouseleave="hideTooltip" @mousemove="checkTooltipVisibility">
        <svg v-show="viewMode === 'tree'" ref="svgRef" width="100%"></svg>

<div v-if="viewMode === 'grid'" class="grid-table">
     <div class="grid-header" style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                <div class="col-hier" style="color: #6366f1; padding-left: 54px;">Hierarchy / Component Name</div>
    </div>
    <div class="grid-body">
    <template v-for="ear in currentHierarchyData.children" :key="ear.id">
        <div class="row level-1 parent-row" @click="toggleGridExpand(ear)">
            <div class="col-hier full-width">
                <span class="toggle-icon">{{ ear.isExpanded ? '−' : '+' }}</span>
                <span class="dot exec"></span> 
                <span class="node-name">{{ ear.name }}</span>
                <span class="count-badge">({{ ear.children ? ear.children.length : 0 }})</span>
            </div>
        </div>
        
        <template v-if="ear.isExpanded">
            <template v-for="appType in ear.children" :key="appType.id">
                <div class="row level-2 parent-row" @click="toggleGridExpand(appType)">
                    <div class="col-hier full-width">
                        <span class="guide-line"></span>
                        <span class="toggle-icon">{{ appType.isExpanded ? '−' : '+' }}</span>
                        <span class="dot ear"></span> 
                        <span class="node-name">{{ appType.name }}</span>
                        <span class="count-badge">({{ appType.children ? appType.children.length : 0 }})</span>
                    </div>
                </div>

                <template v-if="appType.isExpanded">
                    <template v-for="war in appType.children" :key="war.id">
                        <div class="row level-3 parent-row" @click="toggleGridExpand(war)">
                            <div class="col-hier full-width">
                                <span class="guide-line"></span>
                                <span class="guide-line level-2-line"></span>
                                <span class="toggle-icon">{{ war.isExpanded ? '−' : '+' }}</span>
                                <span class="dot war"></span> 
                                <span class="node-name">{{ war.name }}</span>
                                <span class="count-badge">({{ war.totalCount }})</span>
                            </div>
                        </div>

                        <template v-if="war.isExpanded">
                            
                            <div class="grid-header">
                                <div class="col-hier" style="color: #6366f1; padding-left: 20px;">WAR NAME</div>
                                <div class="col-ver">Versions (Cur | Allow)</div>
                                <div class="col-meta">Branch / Date</div>
                                <div class="col-ids">Metadata (AIT | ID)</div>
                                <div class="col-status">Status</div>
                            </div>
                            
                            <template v-for="jar in war.children" :key="jar.id">
                                <template v-if="jar.type === 'jar'">
                                    <div class="row level-4 jar-row grid-row">
                                        <div class="col-hier">
                                            <span class="guide-line"></span>
                                            <span class="guide-line level-2-line"></span>
                                            <span class="guide-line level-3-line"></span>
                                            <span class="dot small" :class="jar.isRisk ? 'viol' : 'comp'"></span> 
                                            <span class="jar-name">{{ jar.name }}</span>
                                        </div>
                                        <div class="col-ver text-sm">
                                            <span class="ver-curr">{{ jar.data.currentVersion }}</span>
                                            <span class="ver-sep">/</span>
                                            <span class="ver-allow">{{ jar.data.allowedVersion }}</span>
                                        </div>
                                        <div class="col-meta text-sm">
                                            <div class="branch-name">{{ jar.data.branch }}</div>
                                            <div class="date-text">{{ jar.data.deployedDate?.split(' ')[0] }}</div>
                                        </div>
                                        <div class="col-ids text-sm text-muted">
                                            <div>AIT: {{ jar.data.aitNumber }}</div>
                                            <div>Job: {{ jar.data.ansibleJobId }}</div>
                                        </div>
                                        <div class="col-status">
                                            <span v-if="jar.data.violationReason" class="warn-pill">
                                                ⚠️ {{ jar.data.violationReason }}
                                            </span>
                                            <span v-else class="na-text">N/A</span>
                                        </div>
                                    </div>
                                </template>
                            </template>
                            
                            <div class="level-4 footer-row" 
                                v-if="war.totalCount > leafPageSize" 
                                @click.stop 
                                style="display: flex; justify-content: center; align-items: center; padding: 12px 0; width: 100%; border-bottom: 1px solid #f1f5f9;">
                                
                                <div class="pagination-box">
                                    <button class="btn-page" :disabled="war.gridPage === 1" @click.stop="changeGroupPage(war, -1)">◀</button>
                                    <span class="page-counter">{{ war.gridPage }} / {{ Math.ceil(war.totalCount / leafPageSize) }}</span>
                                    <button class="btn-page" :disabled="war.gridPage * leafPageSize >= war.totalCount" @click.stop="changeGroupPage(war, 1)">▶</button>
                                </div>
                            </div>

                        </template>
                    </template>
                </template>
            </template>
        </template>
    </template>
</div>
</div>
      </div>

    </div>
    <div ref="tooltipRef" class="tooltip-bubble"></div>
  </div>
</template>

<style scoped>
/* GLOBAL RESET */
:global(body), :global(html) { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }

.app-container { display: flex; flex-direction: column; width: 100%; height: 100vh; background: #f8fafc; color: #334155; }

/* HEADER */
/* --- HEADER LAYOUT --- */
.header { 
    flex: 0 0 64px; 
    background: #ffffff; 
    border-bottom: 1px solid #e2e8f0; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 0 32px; 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
    z-index: 10;
}

.left-controls, .right-controls { display: flex; align-items: center; gap: 16px; }

/* --- ENVIRONMENT SELECTOR (LEFT SIDE - AWESOME DESIGN) --- */
.env-selector-wrapper {
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: #f8fafc;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 4px 12px;
    min-width: 240px; /* Wider as requested */
    height: 42px;
    position: relative;
    transition: all 0.2s ease;
}

.env-selector-wrapper:hover {
    border-color: #6366f1;
    background: #fff;
    box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
}

.env-label {
    font-size: 9px;
    font-weight: 800;
    color: #94a3b8;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    margin-bottom: -2px;
}

.select-container {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
}

.env-dropdown {
    width: 100%;
    appearance: none;
    -webkit-appearance: none;
    border: none;
    background: transparent;
    font-size: 14px;
    font-weight: 700;
    color: #334155;
    cursor: pointer;
    outline: none;
    padding-right: 20px;
    margin: 0;
}

.env-dropdown:focus { color: #4f46e5; }

.dropdown-arrow {
    position: absolute;
    right: 0;
    top: 2px;
    color: #64748b;
    pointer-events: none;
}
.left-controls, .right-controls { display: flex; align-items: center; gap: 12px; }

/* SEARCH TAGS - FIXED BLACK BG */
/* --- SEARCH BAR (RIGHT SIDE) --- */
.search-wrapper { 
    position: relative; 
    display: flex; 
    align-items: center; 
    background: #ffffff; 
    border: 1px solid #e2e8f0; 
    border-radius: 8px;
    padding: 0 12px; 
    width: 320px; 
    height: 38px;
    transition: all 0.2s; 
}

.search-wrapper:focus-within { 
    border-color: #6366f1; 
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); 
}

.search-icon { color: #94a3b8; margin-right: 8px; display: flex; }

.tags-container { 
    display: flex; 
    flex-wrap: nowrap; 
    gap: 4px; 
    flex: 1; 
    align-items: center; 
    overflow-x: auto;
    scrollbar-width: none; /* Hide scrollbar */
}

.search-input-field { 
    border: none; 
    outline: none; 
    font-size: 13px; 
    color: #334155; 
    flex: 1; 
    background: transparent; 
    min-width: 80px;
}

.tag-pill {
    background: #e0e7ff; color: #4338ca; font-size: 11px; font-weight: 600; 
    padding: 2px 8px; border-radius: 4px; white-space: nowrap; display: flex; align-items: center; gap: 4px;
}
.tag-close { cursor: pointer; font-size: 12px; opacity: 0.6; }
.tag-close:hover { opacity: 1; }

/* --- VERTICAL SEPARATOR --- */
.separator { width: 1px; height: 24px; background: #e2e8f0; }

/* --- VIEW TOGGLE (SEGMENTED CONTROL) --- */
.view-toggle { 
    display: flex; 
    background: #f1f5f9; 
    padding: 4px; 
    border-radius: 8px; 
    border: 1px solid #e2e8f0;
}

.view-toggle button { 
    border: none; 
    background: transparent; 
    padding: 6px 14px; 
    font-size: 12px; 
    font-weight: 600; 
    color: #64748b; 
    cursor: pointer; 
    border-radius: 6px; 
    transition: all 0.2s; 
    display: flex; 
    align-items: center; 
    gap: 6px;
}

.view-toggle button:hover { color: #334155; }

.view-toggle button.active { 
    background: white; 
    color: #6366f1; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    font-weight: 700;
}

.view-toggle .icon { font-size: 14px; line-height: 1; }

/* --- PAGINATION --- */
.pagination-ctrl { display: flex; align-items: center; gap: 8px; }

.pagination-ctrl button { 
    width: 32px; height: 32px; 
    border: 1px solid #e2e8f0; 
    background: white; 
    border-radius: 8px; 
    cursor: pointer; 
    display: flex; align-items: center; justify-content: center; 
    font-size: 16px; 
    color: #64748b;
    transition: all 0.2s;
}

.pagination-ctrl button:hover:not(:disabled) { 
    border-color: #cbd5e1; color: #334155; background: #f8fafc; 
}

.pagination-ctrl button:disabled { opacity: 0.5; cursor: not-allowed; }

.page-text { 
    font-size: 13px; font-weight: 700; color: #334155; 
    min-width: 40px; text-align: center; 
}
.text-muted { color: #94a3b8; font-weight: 500; }

/* TOGGLE */
.view-toggle { display: flex; background: #f1f5f9; padding: 3px; border-radius: 6px; }
.view-toggle button { 
    border: none; background: transparent; padding: 4px 12px; font-size: 12px; 
    font-weight: 600; color: #64748b; cursor: pointer; border-radius: 4px; transition: all 0.2s; 
}
.view-toggle button.active { background: white; color: #6366f1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

/* LEGEND BAR */
.legend-bar { 
    flex: 0 0 36px; background: white; border-bottom: 1px solid #e2e8f0; 
    display: flex; align-items: center; padding: 0 24px; gap: 16px; font-size: 11px; color: #64748b;
    justify-content: flex-end; /* ALIGN RIGHT */
}
.legend-item { display: flex; align-items: center; gap: 5px; font-weight: 600; }
.dot { width: 10px; height: 10px; border-radius: 50%; }
.exec { background: #6366f1; }
.war { background: #f59e0b; }
.viol { background: #f43f5e; }
.comp { background: #10b981; }
.small { width: 8px; height: 8px; }
.loading-text { color: #6366f1; font-weight: 600; margin-right: auto; }
.error-text { color: #f43f5e; font-weight: 600; margin-right: auto; }

/* CONTENT AREA */
.content-area { 
    flex: 1; overflow: auto; padding: 20px; background: #f8f9fa;
    scrollbar-width: none; -ms-overflow-style: none;
}
.content-area::-webkit-scrollbar { width: 6px; height: 6px; }
.content-area::-webkit-scrollbar-track { background: transparent; }
.content-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

.view-card {
    background: white; border: 1px solid #e2e8f0; border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); min-height: 100%; position: relative;
}

/* --- IMPROVED GRID TABLE STYLES --- */

/* 1. Layout & Geometry */
.grid-header, .row {
    display: grid;
    /* Adjusted Columns: Give hierarchy more space, tighter metadata columns */
    grid-template-columns: minmax(320px, 4fr) 1.2fr 1.4fr 1.2fr 110px;
    align-items: center;
    gap: 16px; /* Increased gap for better readability */
    padding: 10px 20px; /* More breathing room */
}

.grid-header {
    position: sticky;
    top: 0;
    z-index: 5;
    background: #f1f5f9;
    border-bottom: 1px solid #cbd5e1;
    font-size: 12px;
    font-weight: 700;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    height: 48px;
}

.row {
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.1s ease;
    cursor: pointer;
    min-height: 44px; /* Ensure rows aren't too squashed */
}

.row:hover {
    background-color: #f8fafc;
}

/* 2. Hierarchy & Toggle Buttons */
.col-hier {
    display: flex;
    align-items: center;
    gap: 10px; /* Space between icon/dot/text */
    overflow: hidden;
    position: relative;
    height: 100%;
}

/* The Expand Button */
.toggle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    border: 1px solid transparent;
    background: transparent;
    color: #94a3b8;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.toggle-btn:hover {
    background: #e2e8f0;
    color: #475569;
}

.toggle-btn svg {
    width: 16px;
    height: 16px;
    transition: transform 0.2s ease;
}

.toggle-btn.rotated svg {
    transform: rotate(90deg);
}

/* 3. Guide Lines (Vertical Indentation) */
/* We move the indentation logic to margins/padding on the toggle button wrapper */
.guide-line {
    position: absolute;
    top: -50%; 
    bottom: -50%; /* Extends line to connect rows */
    width: 1px;
    background-color: #e2e8f0;
    pointer-events: none;
}

/* Specific Line Positions relative to left edge */
.level-1-line { left: 11px; } /* Center of the first toggle button */
.level-2-line { left: 45px; } 
.level-3-line { left: 79px; }

/* Indentation Spacing for nested rows */
/* Level 1 is default */
.level-2 .col-hier { padding-left: 34px; }
.level-3 .col-hier { padding-left: 68px; }
.level-4 .col-hier { padding-left: 102px; }

.spacer-leaf {
    width: 24px; /* Replaces the toggle button space for leaf nodes */
    flex-shrink: 0;
}

/* 4. Typography & Visuals */

/* Font Sizing Bump */
.node-name {
    font-size: 14px; /* Increased from 11px */
    font-weight: 600;
    color: #1e293b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.primary-text {
    font-size: 15px;
    color: #0f172a;
}

.jar-name {
    font-size: 13.5px;
    color: #334155;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.count-badge {
    font-size: 12px;
    color: #94a3b8;
    background: #f1f5f9;
    padding: 2px 8px;
    border-radius: 12px;
    
    /* --- CHANGE THIS --- */
    /* margin-left: auto;  <-- DELETE THIS LINE */
    margin-left: 12px;  /* <-- ADD THIS LINE */
    /* ------------------- */
}

/* Column Text Styling */
.col-ver {
    font-size: 13px;
    font-family: 'Consolas', 'Monaco', monospace; /* Monospace for numbers looks better */
    color: #334155;
}
.ver-curr { font-weight: 700; color: #0f172a; }
.ver-sep { margin: 0 4px; color: #cbd5e1; }
.ver-allow { color: #64748b; }

.col-meta {
    display: flex;
    flex-direction: column;
    justify-content: center;
    font-size: 12px;
    line-height: 1.4;
}
.branch-name { font-weight: 600; color: #475569; }
.date-text { color: #94a3b8; }

.col-ids {
    font-size: 11px;
    color: #64748b;
    line-height: 1.3;
}
.col-ids .label { font-weight: 600; color: #94a3b8; margin-right: 4px; }

/* Status Pills */
.warn-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: #fef2f2;
    color: #ef4444;
    border: 1px solid #fecaca;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    max-width: 100%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.warn-icon { width: 12px; height: 12px; }

.status-ok {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #10b981;
    font-size: 12px;
    font-weight: 600;
}
.ok-icon { width: 14px; height: 14px; }
.na-text { color: #cbd5e1; font-style: italic; font-size: 12px; }

/* 5. Pagination Box in Grid */
.footer-row {
    background-color: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: center;
    padding: 8px 0;
}

.pagination-box {
    background: white;
    border: 1px solid #e2e8f0;
    padding: 2px 8px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.btn-page { 
    background: white; border: 1px solid #e2e8f0; padding: 4px 10px; 
    font-size: 11px; font-weight: 600; color: #475569; border-radius: 4px; 
    cursor: pointer; transition: all 0.2s; 
}
.btn-page:hover:not(:disabled) { border-color: #94a3b8; color: #0f172a; background: #f8fafc; }
.btn-page:disabled { opacity: 0.4; cursor: not-allowed; }
.page-counter { font-size: 11px; font-weight: 600; color: #64748b; }

.tooltip-bubble { 
    position: absolute; background: white; border: 1px solid #e2e8f0; 
    padding: 8px; border-radius: 6px; font-size: 11px; color: #334155; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 9999; pointer-events: none; opacity: 0;
    pointer-events: none; /* Crucial for preventing sticky behavior */
    z-index: 9999;
    transition: opacity 0.2s; /* Optional: smooth fade out */
}
:deep(.tt-header) { font-weight: 700; font-size: 12px; margin-bottom: 4px; color: #4338ca; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px; }
:deep(.tt-grid) { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
</style>